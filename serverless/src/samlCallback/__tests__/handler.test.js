import samlCallback from '../handler'
import * as getConfig from '../../../../static/src/js/utils/getConfig'

beforeEach(() => {
  jest.clearAllMocks()
})

describe('samlCallback is called by launchpad after a successful login in production mode', () => {
  test('returns a redirect to the mmt app and encodes the launchpad token in a cookie', async () => {
    const event = {
      body: 'RelayState=%2Fhome&SAMLResponse=PFJlc3BvbnNlIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIERlc3RpbmF0aW9uPSJodHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzIiBJRD0iXzI5YjNmOTU1MzEyYTNjNjhkYjQ5ZWRhMzRmMjI2NmYwZTQxMSIgSW5SZXNwb25zZVRvPSJfZDVlMzMzNzYwYmQ4ZDE4Yjg3MmQyZDIxYmRhOWRkNDRlOGIxYzc2NSIgSXNzdWVJbnN0YW50PSIyMDI0LTAxLTI0VDIxOjI2OjA1WiIgVmVyc2lvbj0iMi4wIj4NCiAgICA8bnMxOklzc3VlciB4bWxuczpuczE9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5Ij5odHRwczovL2F1dGgubGF1bmNocGFkLXNieC5uYXNhLmdvdjwvbnMxOklzc3Vlcj4NCiAgICA8U3RhdHVzPg0KICAgICAgICA8U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8%2BDQogICAgPC9TdGF0dXM%2BDQogICAgPG5zMjpBc3NlcnRpb24geG1sbnM6bnMyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBJRD0iXzc2N2JkMTY2OWYxMDdkMTIyM2JkNGQyNjFkNWMwOGI3NWY5MCIgSXNzdWVJbnN0YW50PSIyMDI0LTAxLTI0VDIxOjI2OjA1WiIgVmVyc2lvbj0iMi4wIj4NCiAgICAgICAgPG5zMjpJc3N1ZXIgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDplbnRpdHkiPmh0dHBzOi8vYXV0aC5sYXVuY2hwYWQtc2J4Lm5hc2EuZ292PC9uczI6SXNzdWVyPjxkczpTaWduYXR1cmUgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpTaWduZWRJbmZvPjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8%2BPGRzOlNpZ25hdHVyZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3JlI3JzYS1zaGEyNTYiLz48ZHM6UmVmZXJlbmNlIFVSST0iI183NjdiZDE2NjlmMTA3ZDEyMjNiZDRkMjYxZDVjMDhiNzVmOTAiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybXM%2BPGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkczpEaWdlc3RWYWx1ZT42T1pVQld6UU9nVURUT0ZjVSs2TGFzd29xK2VtY3dldTlqTXE5bDhCbXA4PTwvZHM6RGlnZXN0VmFsdWU%2BPC9kczpSZWZlcmVuY2U%2BPC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZT5KWU9wTDdmMkdDZy96UGFEcVptMS9aeUFjTkNLN2phcGZibWdnRjNPNFJ4YlRrazlGclZRUks2YnU3bWkyZmFnV2hBczlyay92K3BFR2M0UkhVak9UWVlZcGZQcGl5TVl5ZGkzWWZISzFwMGdPNERzbG9wZ2VVSjZVRllXSzZhV1FRQ0RwREtSMS9CSEZIZ3UyS3ZmYWFPMGZvejlrdFlaaUxvcWhYQnBDOTd2SzdPRWxJamhINk42UzZFMll6cjBqREVydm9Kb2lmL3hqL3g5d05sbUdxWW9uNm1jSnZidWZPL3BBMDl4cFFqbGlLOVJZTG91Y0dxQzJRRWhldDNVQTN2dzBuazRvNitRT1BENVdEMXlHNXZWZnY5ekhvd0VGNFlMUy9sYnQwOFROSm9xYlUvckdKT3R1SS9YRDg3aWlra2wyWnBsU1hqOEhqMEFscGpVMXc9PTwvZHM6U2lnbmF0dXJlVmFsdWU%2BPGRzOktleUluZm8geG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUdzVENDQlptZ0F3SUJBZ0lUSVFBTEdCWER6MHV3SE9PaDJRQUJBQXNZRlRBTkJna3Foa2lHOXcwQkFRc0ZBREJnTVJNd0VRWUtDWkltaVpQeUxHUUJHUllEWjI5Mk1SUXdFZ1lLQ1pJbWlaUHlMR1FCR1JZRWJtRnpZVEVUTUJFR0NnbVNKb21UOGl4a0FSa1dBMjVrWXpFZU1Cd0dBMVVFQXhNVlRrRlRRU0JPUkVNZ1NYTnpkV2x1WnlCRFFTQXlNQjRYRFRJeU1UQXhNakV6TlRJMU1Wb1hEVEkwTVRBeE1URXpOVEkxTVZvd1l6RUxNQWtHQTFVRUJoTUNWVk14Q3pBSkJnTlZCQWdUQWtGTU1STXdFUVlEVlFRSEV3cElkVzUwYzNacGJHeGxNUTB3Q3dZRFZRUUtFd1JPUVZOQk1TTXdJUVlEVlFRREV4cHBaSEF1YkdGMWJtTm9jR0ZrTFhOaWVDNXVZWE5oTG1kdmRqQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU9OWWJ1Q0ZPSyttWmdxNXZZanRWNkxrRkhhL095Vk9ObmNQdURvS3QvRTNsbGF2YTJaNEJmT3FYT1orQmlMMW9ld2RLQXNjUk80VzE1V2NMOGRqcFoveUE3MFRxbXJJd1lDWFlDcTZHOHlKQ0xTSGhyNjZLZVRXVXBXRjRGZE5UTlRHRE5YMytlKy9FQ0t1MEFFNmZwdWtsaENhNnFSTDE2V1BZVTJFdzNWcGpoQytJQlpFR2VYa3VvMDd2RUxmZHlaWWo1Y1FNYlpBSC9EbDRQYzl2OVd4QjBCVEV3ZXQvMTYwdHcvMnlHSkNhVVAvL3AwZHcza01XekFXOUpjcGlhMnRxRHRlT1VyRlhaWnNkNVpRUnNsL1FnOXBtTDJPRG9PVENsQmE1dGdOdVFmRUJaWHdERXVIbFRVTm8vM2FUMUkxMDM4b3c5T1RUSVNBVldaUUo3OENBd0VBQWFPQ0ExOHdnZ05iTUNVR0ExVWRFUVFlTUJ5Q0dtbGtjQzVzWVhWdVkyaHdZV1F0YzJKNExtNWhjMkV1WjI5Mk1CMEdBMVVkRGdRV0JCU0ZaR2lrOUQ3dzlKR25lOWRkOFhBeE85TjM5akFmQmdOVkhTTUVHREFXZ0JTZkprTWd3N2ROQTZXY0Q0UzF6NzFpdnlia25qQ0NBUzBHQTFVZEh3U0NBU1F3Z2dFZ01JSUJIS0NDQVJpZ2dnRVVob0hIYkdSaGNEb3ZMeTlEVGoxT1FWTkJKVEl3VGtSREpUSXdTWE56ZFdsdVp5VXlNRU5CSlRJd01pZ3hLU3hEVGoxamNtd3NRMDQ5UTBSUUxFTk9QVkIxWW14cFl5VXlNRXRsZVNVeU1GTmxjblpwWTJWekxFTk9QVk5sY25acFkyVnpMRU5PUFVOdmJtWnBaM1Z5WVhScGIyNHNSRU05Ym1SakxFUkRQVzVoYzJFc1JFTTlaMjkyUDJObGNuUnBabWxqWVhSbFVtVjJiMk5oZEdsdmJreHBjM1EvWW1GelpUOXZZbXBsWTNSRGJHRnpjejFqVWt4RWFYTjBjbWxpZFhScGIyNVFiMmx1ZElaSWFIUjBjRG92TDJOa2NHZ3VibVJqTG01aGMyRXVaMjkyTDBObGNuUkZibkp2Ykd3dlRrRlRRU1V5TUU1RVF5VXlNRWx6YzNWcGJtY2xNakJEUVNVeU1ESW9NU2t1WTNKc01JSUJLd1lJS3dZQkJRVUhBUUVFZ2dFZE1JSUJHVENCd0FZSUt3WUJCUVVITUFLR2diTnNaR0Z3T2k4dkwwTk9QVTVCVTBFbE1qQk9SRU1sTWpCSmMzTjFhVzVuSlRJd1EwRWxNakF5TEVOT1BVRkpRU3hEVGoxUWRXSnNhV01sTWpCTFpYa2xNakJUWlhKMmFXTmxjeXhEVGoxVFpYSjJhV05sY3l4RFRqMURiMjVtYVdkMWNtRjBhVzl1TEVSRFBXNWtZeXhFUXoxdVlYTmhMRVJEUFdkdmRqOWpRVU5sY25ScFptbGpZWFJsUDJKaGMyVS9iMkpxWldOMFEyeGhjM005WTJWeWRHbG1hV05oZEdsdmJrRjFkR2h2Y21sMGVUQlVCZ2dyQmdFRkJRY3dBb1pJYUhSMGNEb3ZMMk5rY0dndWJtUmpMbTVoYzJFdVoyOTJMME5sY25SRmJuSnZiR3d2VGtGVFFTVXlNRTVFUXlVeU1FbHpjM1ZwYm1jbE1qQkRRU1V5TURJb01Ta3VZM0owTUFzR0ExVWREd1FFQXdJRm9EQTlCZ2tyQmdFRUFZSTNGUWNFTURBdUJpWXJCZ0VFQVlJM0ZRaUJ4dWdFaHMvYWRZS1ZteDZIL2Y1aGc4VGdPbnFDeWFFbWc3aVhmZ0lCWkFJQklUQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBZ1lJS3dZQkJRVUhBd0V3SndZSkt3WUJCQUdDTnhVS0JCb3dHREFLQmdnckJnRUZCUWNEQWpBS0JnZ3JCZ0VGQlFjREFUQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFPdlp0TFVZaU9GeFFWZENjbGtDMXpPRkdsTEUxNTBBT1Q0eFpISXdzd1hKcnJjcUNkVEsxbFZEUHB1V3dBUUFSd3d0SzVmL3Jwck1JbytMNVNZb0E0UE1zRTg0cnN6Y0ZjOVh1TUFacnk4V1Q4N1NBSFNRSDBvYVp4VnBmbmo3bEdmeFMrcTNYcnRQOFhYdURIWlhoamZqVkxuOVBKYjUzTEdHaERsaVJEZi9RUERlcGZ6eXUxQUU3eGRpbHV3bmtRTEViWE9vSTIrNWxMQjFJSWpHWldjaHk2czdBajNjTStRRWUrMXkwRU5mMU94ejNWVmJ5K3ZZSStHSnUycDZ6NngzVTJBR05icS9sekRzcG1aNEYwbU9XR3pNWFk2V3U1TUNhUTBGZ3BuQVdUbjVFZ2JDV1FKcmlYQ2xjZGJIaUc1RCt2dUxKMVMxMVhZd005a1NVR3c9PTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE%2BPC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPg0KICAgICAgICA8bnMyOlN1YmplY3Q%2BDQogICAgICAgICAgICA8bnMyOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI%2BXzc5MDNmOWM0YzQzMmM4NzVhOTUzMzg1NzU2ZjNmMTU5NjM2ZjwvbnMyOk5hbWVJRD4NCiAgICAgICAgICAgIDxuczI6U3ViamVjdENvbmZpcm1hdGlvbiBNZXRob2Q9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjbTpiZWFyZXIiPg0KICAgICAgICAgICAgICAgIDxuczI6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgSW5SZXNwb25zZVRvPSJfZDVlMzMzNzYwYmQ4ZDE4Yjg3MmQyZDIxYmRhOWRkNDRlOGIxYzc2NSIgTm90T25PckFmdGVyPSIyMDI0LTAxLTI0VDIxOjI3OjM1WiIgUmVjaXBpZW50PSJodHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzIi8%2BDQogICAgICAgICAgICA8L25zMjpTdWJqZWN0Q29uZmlybWF0aW9uPg0KICAgICAgICA8L25zMjpTdWJqZWN0Pg0KICAgICAgICA8bnMyOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDI0LTAxLTI0VDIxOjI1OjM1WiIgTm90T25PckFmdGVyPSIyMDI0LTAxLTI0VDIxOjI3OjM1WiI%2BDQogICAgICAgICAgICA8bnMyOkF1ZGllbmNlUmVzdHJpY3Rpb24%2BDQogICAgICAgICAgICAgICAgPG5zMjpBdWRpZW5jZT5odHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzPC9uczI6QXVkaWVuY2U%2BDQogICAgICAgICAgICA8L25zMjpBdWRpZW5jZVJlc3RyaWN0aW9uPg0KICAgICAgICA8L25zMjpDb25kaXRpb25zPg0KICAgICAgICA8bnMyOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAyNC0wMS0yNFQyMToyNTozOVoiIFNlc3Npb25JbmRleD0iWjV5UGNSNmE4U2FLZGJOb1BMWHh4V01PVEE0PWlLSXdvdz09Ij4NCiAgICAgICAgICAgIDxuczI6QXV0aG5Db250ZXh0Pg0KICAgICAgICAgICAgICAgIDxuczI6QXV0aG5Db250ZXh0Q2xhc3NSZWY%2BdXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRQcm90ZWN0ZWRUcmFuc3BvcnQ8L25zMjpBdXRobkNvbnRleHRDbGFzc1JlZj4NCiAgICAgICAgICAgIDwvbnMyOkF1dGhuQ29udGV4dD4NCiAgICAgICAgPC9uczI6QXV0aG5TdGF0ZW1lbnQ%2BDQogICAgICAgIDxuczI6QXR0cmlidXRlU3RhdGVtZW50Pg0KICAgICAgICAgICAgPG5zMjpBdHRyaWJ1dGUgTmFtZT0iYXVpZCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1bnNwZWNpZmllZCI%2BDQogICAgICAgICAgICAgICAgPG5zMjpBdHRyaWJ1dGVWYWx1ZT5jZ29rZXk8L25zMjpBdHRyaWJ1dGVWYWx1ZT4NCiAgICAgICAgICAgIDwvbnMyOkF0dHJpYnV0ZT4NCiAgICAgICAgICAgIDxuczI6QXR0cmlidXRlIE5hbWU9ImVtYWlsIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVuc3BlY2lmaWVkIj4NCiAgICAgICAgICAgICAgICA8bnMyOkF0dHJpYnV0ZVZhbHVlPmNocmlzdG9waGVyLmQuZ29rZXlAbmFzYS5nb3Y8L25zMjpBdHRyaWJ1dGVWYWx1ZT4NCiAgICAgICAgICAgIDwvbnMyOkF0dHJpYnV0ZT4NCiAgICAgICAgPC9uczI6QXR0cmlidXRlU3RhdGVtZW50Pg0KICAgIDwvbnMyOkFzc2VydGlvbj4NCjwvUmVzcG9uc2U%2B',
      headers: {
        Cookie: 'SBXSESSION=launchpad_token'
      }
    }
    jest.spyOn(getConfig, 'getApplicationConfig').mockImplementation(() => ({
      mmtHost: 'https://mmt.localtest.earthdata.nasa.gov',
      apiHost: 'https://mmt.localtest.earthdata.nasa.gov/dev',
      graphQlHost: 'http://localhost:3013/dev/api',
      cmrHost: 'http://localhost:4000',
      version: 'sit'
    }))

    const response = await samlCallback(event)
    const { headers, statusCode } = response
    const { Location } = headers
    const cookies = headers['Set-Cookie']

    expect(statusCode).toBe(303)
    expect(Location).toBe('https://mmt.localtest.earthdata.nasa.gov/auth_callback?target=%2Fhome')
    expect(cookies).toEqual('data=eyJhdWlkIjoiY2dva2V5IiwiZW1haWwiOiJjaHJpc3RvcGhlci5kLmdva2V5QG5hc2EuZ292IiwibmFtZSI6ImNnb2tleSIsInRva2VuIjoibGF1bmNocGFkX3Rva2VuIn0=; Secure; Path=/; Domain=.earthdatacloud.nasa.gov')
  })
})

describe('when url parameters are provided in the relay state', () => {
  test('the params are persisted through the redirect', async () => {
    const event = {
      body: 'RelayState=%2Fhome%3Fparam%3Dtest&SAMLResponse=PFJlc3BvbnNlIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIERlc3RpbmF0aW9uPSJodHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzIiBJRD0iXzI5YjNmOTU1MzEyYTNjNjhkYjQ5ZWRhMzRmMjI2NmYwZTQxMSIgSW5SZXNwb25zZVRvPSJfZDVlMzMzNzYwYmQ4ZDE4Yjg3MmQyZDIxYmRhOWRkNDRlOGIxYzc2NSIgSXNzdWVJbnN0YW50PSIyMDI0LTAxLTI0VDIxOjI2OjA1WiIgVmVyc2lvbj0iMi4wIj4NCiAgICA8bnMxOklzc3VlciB4bWxuczpuczE9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5Ij5odHRwczovL2F1dGgubGF1bmNocGFkLXNieC5uYXNhLmdvdjwvbnMxOklzc3Vlcj4NCiAgICA8U3RhdHVzPg0KICAgICAgICA8U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8%2BDQogICAgPC9TdGF0dXM%2BDQogICAgPG5zMjpBc3NlcnRpb24geG1sbnM6bnMyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBJRD0iXzc2N2JkMTY2OWYxMDdkMTIyM2JkNGQyNjFkNWMwOGI3NWY5MCIgSXNzdWVJbnN0YW50PSIyMDI0LTAxLTI0VDIxOjI2OjA1WiIgVmVyc2lvbj0iMi4wIj4NCiAgICAgICAgPG5zMjpJc3N1ZXIgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDplbnRpdHkiPmh0dHBzOi8vYXV0aC5sYXVuY2hwYWQtc2J4Lm5hc2EuZ292PC9uczI6SXNzdWVyPjxkczpTaWduYXR1cmUgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpTaWduZWRJbmZvPjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8%2BPGRzOlNpZ25hdHVyZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3JlI3JzYS1zaGEyNTYiLz48ZHM6UmVmZXJlbmNlIFVSST0iI183NjdiZDE2NjlmMTA3ZDEyMjNiZDRkMjYxZDVjMDhiNzVmOTAiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybXM%2BPGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkczpEaWdlc3RWYWx1ZT42T1pVQld6UU9nVURUT0ZjVSs2TGFzd29xK2VtY3dldTlqTXE5bDhCbXA4PTwvZHM6RGlnZXN0VmFsdWU%2BPC9kczpSZWZlcmVuY2U%2BPC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZT5KWU9wTDdmMkdDZy96UGFEcVptMS9aeUFjTkNLN2phcGZibWdnRjNPNFJ4YlRrazlGclZRUks2YnU3bWkyZmFnV2hBczlyay92K3BFR2M0UkhVak9UWVlZcGZQcGl5TVl5ZGkzWWZISzFwMGdPNERzbG9wZ2VVSjZVRllXSzZhV1FRQ0RwREtSMS9CSEZIZ3UyS3ZmYWFPMGZvejlrdFlaaUxvcWhYQnBDOTd2SzdPRWxJamhINk42UzZFMll6cjBqREVydm9Kb2lmL3hqL3g5d05sbUdxWW9uNm1jSnZidWZPL3BBMDl4cFFqbGlLOVJZTG91Y0dxQzJRRWhldDNVQTN2dzBuazRvNitRT1BENVdEMXlHNXZWZnY5ekhvd0VGNFlMUy9sYnQwOFROSm9xYlUvckdKT3R1SS9YRDg3aWlra2wyWnBsU1hqOEhqMEFscGpVMXc9PTwvZHM6U2lnbmF0dXJlVmFsdWU%2BPGRzOktleUluZm8geG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUdzVENDQlptZ0F3SUJBZ0lUSVFBTEdCWER6MHV3SE9PaDJRQUJBQXNZRlRBTkJna3Foa2lHOXcwQkFRc0ZBREJnTVJNd0VRWUtDWkltaVpQeUxHUUJHUllEWjI5Mk1SUXdFZ1lLQ1pJbWlaUHlMR1FCR1JZRWJtRnpZVEVUTUJFR0NnbVNKb21UOGl4a0FSa1dBMjVrWXpFZU1Cd0dBMVVFQXhNVlRrRlRRU0JPUkVNZ1NYTnpkV2x1WnlCRFFTQXlNQjRYRFRJeU1UQXhNakV6TlRJMU1Wb1hEVEkwTVRBeE1URXpOVEkxTVZvd1l6RUxNQWtHQTFVRUJoTUNWVk14Q3pBSkJnTlZCQWdUQWtGTU1STXdFUVlEVlFRSEV3cElkVzUwYzNacGJHeGxNUTB3Q3dZRFZRUUtFd1JPUVZOQk1TTXdJUVlEVlFRREV4cHBaSEF1YkdGMWJtTm9jR0ZrTFhOaWVDNXVZWE5oTG1kdmRqQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU9OWWJ1Q0ZPSyttWmdxNXZZanRWNkxrRkhhL095Vk9ObmNQdURvS3QvRTNsbGF2YTJaNEJmT3FYT1orQmlMMW9ld2RLQXNjUk80VzE1V2NMOGRqcFoveUE3MFRxbXJJd1lDWFlDcTZHOHlKQ0xTSGhyNjZLZVRXVXBXRjRGZE5UTlRHRE5YMytlKy9FQ0t1MEFFNmZwdWtsaENhNnFSTDE2V1BZVTJFdzNWcGpoQytJQlpFR2VYa3VvMDd2RUxmZHlaWWo1Y1FNYlpBSC9EbDRQYzl2OVd4QjBCVEV3ZXQvMTYwdHcvMnlHSkNhVVAvL3AwZHcza01XekFXOUpjcGlhMnRxRHRlT1VyRlhaWnNkNVpRUnNsL1FnOXBtTDJPRG9PVENsQmE1dGdOdVFmRUJaWHdERXVIbFRVTm8vM2FUMUkxMDM4b3c5T1RUSVNBVldaUUo3OENBd0VBQWFPQ0ExOHdnZ05iTUNVR0ExVWRFUVFlTUJ5Q0dtbGtjQzVzWVhWdVkyaHdZV1F0YzJKNExtNWhjMkV1WjI5Mk1CMEdBMVVkRGdRV0JCU0ZaR2lrOUQ3dzlKR25lOWRkOFhBeE85TjM5akFmQmdOVkhTTUVHREFXZ0JTZkprTWd3N2ROQTZXY0Q0UzF6NzFpdnlia25qQ0NBUzBHQTFVZEh3U0NBU1F3Z2dFZ01JSUJIS0NDQVJpZ2dnRVVob0hIYkdSaGNEb3ZMeTlEVGoxT1FWTkJKVEl3VGtSREpUSXdTWE56ZFdsdVp5VXlNRU5CSlRJd01pZ3hLU3hEVGoxamNtd3NRMDQ5UTBSUUxFTk9QVkIxWW14cFl5VXlNRXRsZVNVeU1GTmxjblpwWTJWekxFTk9QVk5sY25acFkyVnpMRU5PUFVOdmJtWnBaM1Z5WVhScGIyNHNSRU05Ym1SakxFUkRQVzVoYzJFc1JFTTlaMjkyUDJObGNuUnBabWxqWVhSbFVtVjJiMk5oZEdsdmJreHBjM1EvWW1GelpUOXZZbXBsWTNSRGJHRnpjejFqVWt4RWFYTjBjbWxpZFhScGIyNVFiMmx1ZElaSWFIUjBjRG92TDJOa2NHZ3VibVJqTG01aGMyRXVaMjkyTDBObGNuUkZibkp2Ykd3dlRrRlRRU1V5TUU1RVF5VXlNRWx6YzNWcGJtY2xNakJEUVNVeU1ESW9NU2t1WTNKc01JSUJLd1lJS3dZQkJRVUhBUUVFZ2dFZE1JSUJHVENCd0FZSUt3WUJCUVVITUFLR2diTnNaR0Z3T2k4dkwwTk9QVTVCVTBFbE1qQk9SRU1sTWpCSmMzTjFhVzVuSlRJd1EwRWxNakF5TEVOT1BVRkpRU3hEVGoxUWRXSnNhV01sTWpCTFpYa2xNakJUWlhKMmFXTmxjeXhEVGoxVFpYSjJhV05sY3l4RFRqMURiMjVtYVdkMWNtRjBhVzl1TEVSRFBXNWtZeXhFUXoxdVlYTmhMRVJEUFdkdmRqOWpRVU5sY25ScFptbGpZWFJsUDJKaGMyVS9iMkpxWldOMFEyeGhjM005WTJWeWRHbG1hV05oZEdsdmJrRjFkR2h2Y21sMGVUQlVCZ2dyQmdFRkJRY3dBb1pJYUhSMGNEb3ZMMk5rY0dndWJtUmpMbTVoYzJFdVoyOTJMME5sY25SRmJuSnZiR3d2VGtGVFFTVXlNRTVFUXlVeU1FbHpjM1ZwYm1jbE1qQkRRU1V5TURJb01Ta3VZM0owTUFzR0ExVWREd1FFQXdJRm9EQTlCZ2tyQmdFRUFZSTNGUWNFTURBdUJpWXJCZ0VFQVlJM0ZRaUJ4dWdFaHMvYWRZS1ZteDZIL2Y1aGc4VGdPbnFDeWFFbWc3aVhmZ0lCWkFJQklUQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBZ1lJS3dZQkJRVUhBd0V3SndZSkt3WUJCQUdDTnhVS0JCb3dHREFLQmdnckJnRUZCUWNEQWpBS0JnZ3JCZ0VGQlFjREFUQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFPdlp0TFVZaU9GeFFWZENjbGtDMXpPRkdsTEUxNTBBT1Q0eFpISXdzd1hKcnJjcUNkVEsxbFZEUHB1V3dBUUFSd3d0SzVmL3Jwck1JbytMNVNZb0E0UE1zRTg0cnN6Y0ZjOVh1TUFacnk4V1Q4N1NBSFNRSDBvYVp4VnBmbmo3bEdmeFMrcTNYcnRQOFhYdURIWlhoamZqVkxuOVBKYjUzTEdHaERsaVJEZi9RUERlcGZ6eXUxQUU3eGRpbHV3bmtRTEViWE9vSTIrNWxMQjFJSWpHWldjaHk2czdBajNjTStRRWUrMXkwRU5mMU94ejNWVmJ5K3ZZSStHSnUycDZ6NngzVTJBR05icS9sekRzcG1aNEYwbU9XR3pNWFk2V3U1TUNhUTBGZ3BuQVdUbjVFZ2JDV1FKcmlYQ2xjZGJIaUc1RCt2dUxKMVMxMVhZd005a1NVR3c9PTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE%2BPC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPg0KICAgICAgICA8bnMyOlN1YmplY3Q%2BDQogICAgICAgICAgICA8bnMyOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI%2BXzc5MDNmOWM0YzQzMmM4NzVhOTUzMzg1NzU2ZjNmMTU5NjM2ZjwvbnMyOk5hbWVJRD4NCiAgICAgICAgICAgIDxuczI6U3ViamVjdENvbmZpcm1hdGlvbiBNZXRob2Q9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjbTpiZWFyZXIiPg0KICAgICAgICAgICAgICAgIDxuczI6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgSW5SZXNwb25zZVRvPSJfZDVlMzMzNzYwYmQ4ZDE4Yjg3MmQyZDIxYmRhOWRkNDRlOGIxYzc2NSIgTm90T25PckFmdGVyPSIyMDI0LTAxLTI0VDIxOjI3OjM1WiIgUmVjaXBpZW50PSJodHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzIi8%2BDQogICAgICAgICAgICA8L25zMjpTdWJqZWN0Q29uZmlybWF0aW9uPg0KICAgICAgICA8L25zMjpTdWJqZWN0Pg0KICAgICAgICA8bnMyOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDI0LTAxLTI0VDIxOjI1OjM1WiIgTm90T25PckFmdGVyPSIyMDI0LTAxLTI0VDIxOjI3OjM1WiI%2BDQogICAgICAgICAgICA8bnMyOkF1ZGllbmNlUmVzdHJpY3Rpb24%2BDQogICAgICAgICAgICAgICAgPG5zMjpBdWRpZW5jZT5odHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzPC9uczI6QXVkaWVuY2U%2BDQogICAgICAgICAgICA8L25zMjpBdWRpZW5jZVJlc3RyaWN0aW9uPg0KICAgICAgICA8L25zMjpDb25kaXRpb25zPg0KICAgICAgICA8bnMyOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAyNC0wMS0yNFQyMToyNTozOVoiIFNlc3Npb25JbmRleD0iWjV5UGNSNmE4U2FLZGJOb1BMWHh4V01PVEE0PWlLSXdvdz09Ij4NCiAgICAgICAgICAgIDxuczI6QXV0aG5Db250ZXh0Pg0KICAgICAgICAgICAgICAgIDxuczI6QXV0aG5Db250ZXh0Q2xhc3NSZWY%2BdXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRQcm90ZWN0ZWRUcmFuc3BvcnQ8L25zMjpBdXRobkNvbnRleHRDbGFzc1JlZj4NCiAgICAgICAgICAgIDwvbnMyOkF1dGhuQ29udGV4dD4NCiAgICAgICAgPC9uczI6QXV0aG5TdGF0ZW1lbnQ%2BDQogICAgICAgIDxuczI6QXR0cmlidXRlU3RhdGVtZW50Pg0KICAgICAgICAgICAgPG5zMjpBdHRyaWJ1dGUgTmFtZT0iYXVpZCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1bnNwZWNpZmllZCI%2BDQogICAgICAgICAgICAgICAgPG5zMjpBdHRyaWJ1dGVWYWx1ZT5jZ29rZXk8L25zMjpBdHRyaWJ1dGVWYWx1ZT4NCiAgICAgICAgICAgIDwvbnMyOkF0dHJpYnV0ZT4NCiAgICAgICAgICAgIDxuczI6QXR0cmlidXRlIE5hbWU9ImVtYWlsIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVuc3BlY2lmaWVkIj4NCiAgICAgICAgICAgICAgICA8bnMyOkF0dHJpYnV0ZVZhbHVlPmNocmlzdG9waGVyLmQuZ29rZXlAbmFzYS5nb3Y8L25zMjpBdHRyaWJ1dGVWYWx1ZT4NCiAgICAgICAgICAgIDwvbnMyOkF0dHJpYnV0ZT4NCiAgICAgICAgPC9uczI6QXR0cmlidXRlU3RhdGVtZW50Pg0KICAgIDwvbnMyOkFzc2VydGlvbj4NCjwvUmVzcG9uc2U%2B',
      headers: {
        Cookie: 'SBXSESSION=launchpad_token'
      }
    }
    jest.spyOn(getConfig, 'getApplicationConfig').mockImplementation(() => ({
      mmtHost: 'https://mmt.localtest.earthdata.nasa.gov',
      apiHost: 'https://mmt.localtest.earthdata.nasa.gov/dev',
      graphQlHost: 'http://localhost:3013/dev/api',
      cmrHost: 'http://localhost:4000',
      version: 'sit'
    }))

    const response = await samlCallback(event)
    const { headers, statusCode } = response
    const { Location } = headers
    const cookies = headers['Set-Cookie']

    expect(statusCode).toBe(303)
    expect(Location).toBe('https://mmt.localtest.earthdata.nasa.gov/auth_callback?target=%2Fhome%3Fparam%3Dtest')
    expect(cookies).toEqual('data=eyJhdWlkIjoiY2dva2V5IiwiZW1haWwiOiJjaHJpc3RvcGhlci5kLmdva2V5QG5hc2EuZ292IiwibmFtZSI6ImNnb2tleSIsInRva2VuIjoibGF1bmNocGFkX3Rva2VuIn0=; Secure; Path=/; Domain=.earthdatacloud.nasa.gov')
  })
})

describe('samlCallback is called by launchpad after a successful login in dev mode', () => {
  test('returns a redirect to the mmt app but uses ABC-1 for the token', async () => {
    const event = {
      body: 'RelayState=%2Fhome&SAMLResponse=PFJlc3BvbnNlIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIERlc3RpbmF0aW9uPSJodHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzIiBJRD0iXzI5YjNmOTU1MzEyYTNjNjhkYjQ5ZWRhMzRmMjI2NmYwZTQxMSIgSW5SZXNwb25zZVRvPSJfZDVlMzMzNzYwYmQ4ZDE4Yjg3MmQyZDIxYmRhOWRkNDRlOGIxYzc2NSIgSXNzdWVJbnN0YW50PSIyMDI0LTAxLTI0VDIxOjI2OjA1WiIgVmVyc2lvbj0iMi4wIj4NCiAgICA8bnMxOklzc3VlciB4bWxuczpuczE9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5Ij5odHRwczovL2F1dGgubGF1bmNocGFkLXNieC5uYXNhLmdvdjwvbnMxOklzc3Vlcj4NCiAgICA8U3RhdHVzPg0KICAgICAgICA8U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8%2BDQogICAgPC9TdGF0dXM%2BDQogICAgPG5zMjpBc3NlcnRpb24geG1sbnM6bnMyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiBJRD0iXzc2N2JkMTY2OWYxMDdkMTIyM2JkNGQyNjFkNWMwOGI3NWY5MCIgSXNzdWVJbnN0YW50PSIyMDI0LTAxLTI0VDIxOjI2OjA1WiIgVmVyc2lvbj0iMi4wIj4NCiAgICAgICAgPG5zMjpJc3N1ZXIgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDplbnRpdHkiPmh0dHBzOi8vYXV0aC5sYXVuY2hwYWQtc2J4Lm5hc2EuZ292PC9uczI6SXNzdWVyPjxkczpTaWduYXR1cmUgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpTaWduZWRJbmZvPjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8%2BPGRzOlNpZ25hdHVyZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3JlI3JzYS1zaGEyNTYiLz48ZHM6UmVmZXJlbmNlIFVSST0iI183NjdiZDE2NjlmMTA3ZDEyMjNiZDRkMjYxZDVjMDhiNzVmOTAiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybXM%2BPGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkczpEaWdlc3RWYWx1ZT42T1pVQld6UU9nVURUT0ZjVSs2TGFzd29xK2VtY3dldTlqTXE5bDhCbXA4PTwvZHM6RGlnZXN0VmFsdWU%2BPC9kczpSZWZlcmVuY2U%2BPC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZT5KWU9wTDdmMkdDZy96UGFEcVptMS9aeUFjTkNLN2phcGZibWdnRjNPNFJ4YlRrazlGclZRUks2YnU3bWkyZmFnV2hBczlyay92K3BFR2M0UkhVak9UWVlZcGZQcGl5TVl5ZGkzWWZISzFwMGdPNERzbG9wZ2VVSjZVRllXSzZhV1FRQ0RwREtSMS9CSEZIZ3UyS3ZmYWFPMGZvejlrdFlaaUxvcWhYQnBDOTd2SzdPRWxJamhINk42UzZFMll6cjBqREVydm9Kb2lmL3hqL3g5d05sbUdxWW9uNm1jSnZidWZPL3BBMDl4cFFqbGlLOVJZTG91Y0dxQzJRRWhldDNVQTN2dzBuazRvNitRT1BENVdEMXlHNXZWZnY5ekhvd0VGNFlMUy9sYnQwOFROSm9xYlUvckdKT3R1SS9YRDg3aWlra2wyWnBsU1hqOEhqMEFscGpVMXc9PTwvZHM6U2lnbmF0dXJlVmFsdWU%2BPGRzOktleUluZm8geG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUdzVENDQlptZ0F3SUJBZ0lUSVFBTEdCWER6MHV3SE9PaDJRQUJBQXNZRlRBTkJna3Foa2lHOXcwQkFRc0ZBREJnTVJNd0VRWUtDWkltaVpQeUxHUUJHUllEWjI5Mk1SUXdFZ1lLQ1pJbWlaUHlMR1FCR1JZRWJtRnpZVEVUTUJFR0NnbVNKb21UOGl4a0FSa1dBMjVrWXpFZU1Cd0dBMVVFQXhNVlRrRlRRU0JPUkVNZ1NYTnpkV2x1WnlCRFFTQXlNQjRYRFRJeU1UQXhNakV6TlRJMU1Wb1hEVEkwTVRBeE1URXpOVEkxTVZvd1l6RUxNQWtHQTFVRUJoTUNWVk14Q3pBSkJnTlZCQWdUQWtGTU1STXdFUVlEVlFRSEV3cElkVzUwYzNacGJHeGxNUTB3Q3dZRFZRUUtFd1JPUVZOQk1TTXdJUVlEVlFRREV4cHBaSEF1YkdGMWJtTm9jR0ZrTFhOaWVDNXVZWE5oTG1kdmRqQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU9OWWJ1Q0ZPSyttWmdxNXZZanRWNkxrRkhhL095Vk9ObmNQdURvS3QvRTNsbGF2YTJaNEJmT3FYT1orQmlMMW9ld2RLQXNjUk80VzE1V2NMOGRqcFoveUE3MFRxbXJJd1lDWFlDcTZHOHlKQ0xTSGhyNjZLZVRXVXBXRjRGZE5UTlRHRE5YMytlKy9FQ0t1MEFFNmZwdWtsaENhNnFSTDE2V1BZVTJFdzNWcGpoQytJQlpFR2VYa3VvMDd2RUxmZHlaWWo1Y1FNYlpBSC9EbDRQYzl2OVd4QjBCVEV3ZXQvMTYwdHcvMnlHSkNhVVAvL3AwZHcza01XekFXOUpjcGlhMnRxRHRlT1VyRlhaWnNkNVpRUnNsL1FnOXBtTDJPRG9PVENsQmE1dGdOdVFmRUJaWHdERXVIbFRVTm8vM2FUMUkxMDM4b3c5T1RUSVNBVldaUUo3OENBd0VBQWFPQ0ExOHdnZ05iTUNVR0ExVWRFUVFlTUJ5Q0dtbGtjQzVzWVhWdVkyaHdZV1F0YzJKNExtNWhjMkV1WjI5Mk1CMEdBMVVkRGdRV0JCU0ZaR2lrOUQ3dzlKR25lOWRkOFhBeE85TjM5akFmQmdOVkhTTUVHREFXZ0JTZkprTWd3N2ROQTZXY0Q0UzF6NzFpdnlia25qQ0NBUzBHQTFVZEh3U0NBU1F3Z2dFZ01JSUJIS0NDQVJpZ2dnRVVob0hIYkdSaGNEb3ZMeTlEVGoxT1FWTkJKVEl3VGtSREpUSXdTWE56ZFdsdVp5VXlNRU5CSlRJd01pZ3hLU3hEVGoxamNtd3NRMDQ5UTBSUUxFTk9QVkIxWW14cFl5VXlNRXRsZVNVeU1GTmxjblpwWTJWekxFTk9QVk5sY25acFkyVnpMRU5PUFVOdmJtWnBaM1Z5WVhScGIyNHNSRU05Ym1SakxFUkRQVzVoYzJFc1JFTTlaMjkyUDJObGNuUnBabWxqWVhSbFVtVjJiMk5oZEdsdmJreHBjM1EvWW1GelpUOXZZbXBsWTNSRGJHRnpjejFqVWt4RWFYTjBjbWxpZFhScGIyNVFiMmx1ZElaSWFIUjBjRG92TDJOa2NHZ3VibVJqTG01aGMyRXVaMjkyTDBObGNuUkZibkp2Ykd3dlRrRlRRU1V5TUU1RVF5VXlNRWx6YzNWcGJtY2xNakJEUVNVeU1ESW9NU2t1WTNKc01JSUJLd1lJS3dZQkJRVUhBUUVFZ2dFZE1JSUJHVENCd0FZSUt3WUJCUVVITUFLR2diTnNaR0Z3T2k4dkwwTk9QVTVCVTBFbE1qQk9SRU1sTWpCSmMzTjFhVzVuSlRJd1EwRWxNakF5TEVOT1BVRkpRU3hEVGoxUWRXSnNhV01sTWpCTFpYa2xNakJUWlhKMmFXTmxjeXhEVGoxVFpYSjJhV05sY3l4RFRqMURiMjVtYVdkMWNtRjBhVzl1TEVSRFBXNWtZeXhFUXoxdVlYTmhMRVJEUFdkdmRqOWpRVU5sY25ScFptbGpZWFJsUDJKaGMyVS9iMkpxWldOMFEyeGhjM005WTJWeWRHbG1hV05oZEdsdmJrRjFkR2h2Y21sMGVUQlVCZ2dyQmdFRkJRY3dBb1pJYUhSMGNEb3ZMMk5rY0dndWJtUmpMbTVoYzJFdVoyOTJMME5sY25SRmJuSnZiR3d2VGtGVFFTVXlNRTVFUXlVeU1FbHpjM1ZwYm1jbE1qQkRRU1V5TURJb01Ta3VZM0owTUFzR0ExVWREd1FFQXdJRm9EQTlCZ2tyQmdFRUFZSTNGUWNFTURBdUJpWXJCZ0VFQVlJM0ZRaUJ4dWdFaHMvYWRZS1ZteDZIL2Y1aGc4VGdPbnFDeWFFbWc3aVhmZ0lCWkFJQklUQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBZ1lJS3dZQkJRVUhBd0V3SndZSkt3WUJCQUdDTnhVS0JCb3dHREFLQmdnckJnRUZCUWNEQWpBS0JnZ3JCZ0VGQlFjREFUQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFPdlp0TFVZaU9GeFFWZENjbGtDMXpPRkdsTEUxNTBBT1Q0eFpISXdzd1hKcnJjcUNkVEsxbFZEUHB1V3dBUUFSd3d0SzVmL3Jwck1JbytMNVNZb0E0UE1zRTg0cnN6Y0ZjOVh1TUFacnk4V1Q4N1NBSFNRSDBvYVp4VnBmbmo3bEdmeFMrcTNYcnRQOFhYdURIWlhoamZqVkxuOVBKYjUzTEdHaERsaVJEZi9RUERlcGZ6eXUxQUU3eGRpbHV3bmtRTEViWE9vSTIrNWxMQjFJSWpHWldjaHk2czdBajNjTStRRWUrMXkwRU5mMU94ejNWVmJ5K3ZZSStHSnUycDZ6NngzVTJBR05icS9sekRzcG1aNEYwbU9XR3pNWFk2V3U1TUNhUTBGZ3BuQVdUbjVFZ2JDV1FKcmlYQ2xjZGJIaUc1RCt2dUxKMVMxMVhZd005a1NVR3c9PTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE%2BPC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPg0KICAgICAgICA8bnMyOlN1YmplY3Q%2BDQogICAgICAgICAgICA8bnMyOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI%2BXzc5MDNmOWM0YzQzMmM4NzVhOTUzMzg1NzU2ZjNmMTU5NjM2ZjwvbnMyOk5hbWVJRD4NCiAgICAgICAgICAgIDxuczI6U3ViamVjdENvbmZpcm1hdGlvbiBNZXRob2Q9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjbTpiZWFyZXIiPg0KICAgICAgICAgICAgICAgIDxuczI6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgSW5SZXNwb25zZVRvPSJfZDVlMzMzNzYwYmQ4ZDE4Yjg3MmQyZDIxYmRhOWRkNDRlOGIxYzc2NSIgTm90T25PckFmdGVyPSIyMDI0LTAxLTI0VDIxOjI3OjM1WiIgUmVjaXBpZW50PSJodHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzIi8%2BDQogICAgICAgICAgICA8L25zMjpTdWJqZWN0Q29uZmlybWF0aW9uPg0KICAgICAgICA8L25zMjpTdWJqZWN0Pg0KICAgICAgICA8bnMyOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDI0LTAxLTI0VDIxOjI1OjM1WiIgTm90T25PckFmdGVyPSIyMDI0LTAxLTI0VDIxOjI3OjM1WiI%2BDQogICAgICAgICAgICA8bnMyOkF1ZGllbmNlUmVzdHJpY3Rpb24%2BDQogICAgICAgICAgICAgICAgPG5zMjpBdWRpZW5jZT5odHRwczovL21tdC5sb2NhbHRlc3QuZWFydGhkYXRhLm5hc2EuZ292L3NhbWwvYWNzPC9uczI6QXVkaWVuY2U%2BDQogICAgICAgICAgICA8L25zMjpBdWRpZW5jZVJlc3RyaWN0aW9uPg0KICAgICAgICA8L25zMjpDb25kaXRpb25zPg0KICAgICAgICA8bnMyOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAyNC0wMS0yNFQyMToyNTozOVoiIFNlc3Npb25JbmRleD0iWjV5UGNSNmE4U2FLZGJOb1BMWHh4V01PVEE0PWlLSXdvdz09Ij4NCiAgICAgICAgICAgIDxuczI6QXV0aG5Db250ZXh0Pg0KICAgICAgICAgICAgICAgIDxuczI6QXV0aG5Db250ZXh0Q2xhc3NSZWY%2BdXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRQcm90ZWN0ZWRUcmFuc3BvcnQ8L25zMjpBdXRobkNvbnRleHRDbGFzc1JlZj4NCiAgICAgICAgICAgIDwvbnMyOkF1dGhuQ29udGV4dD4NCiAgICAgICAgPC9uczI6QXV0aG5TdGF0ZW1lbnQ%2BDQogICAgICAgIDxuczI6QXR0cmlidXRlU3RhdGVtZW50Pg0KICAgICAgICAgICAgPG5zMjpBdHRyaWJ1dGUgTmFtZT0iYXVpZCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1bnNwZWNpZmllZCI%2BDQogICAgICAgICAgICAgICAgPG5zMjpBdHRyaWJ1dGVWYWx1ZT5jZ29rZXk8L25zMjpBdHRyaWJ1dGVWYWx1ZT4NCiAgICAgICAgICAgIDwvbnMyOkF0dHJpYnV0ZT4NCiAgICAgICAgICAgIDxuczI6QXR0cmlidXRlIE5hbWU9ImVtYWlsIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVuc3BlY2lmaWVkIj4NCiAgICAgICAgICAgICAgICA8bnMyOkF0dHJpYnV0ZVZhbHVlPmNocmlzdG9waGVyLmQuZ29rZXlAbmFzYS5nb3Y8L25zMjpBdHRyaWJ1dGVWYWx1ZT4NCiAgICAgICAgICAgIDwvbnMyOkF0dHJpYnV0ZT4NCiAgICAgICAgPC9uczI6QXR0cmlidXRlU3RhdGVtZW50Pg0KICAgIDwvbnMyOkFzc2VydGlvbj4NCjwvUmVzcG9uc2U%2B',
      headers: {
        Cookie: 'SBXSESSION=launchpad_token'
      }
    }
    jest.spyOn(getConfig, 'getApplicationConfig').mockImplementation(() => ({
      mmtHost: 'https://mmt.localtest.earthdata.nasa.gov',
      apiHost: 'https://mmt.localtest.earthdata.nasa.gov/dev',
      graphQlHost: 'http://localhost:3013/dev/api',
      cmrHost: 'http://localhost:4000',
      version: 'development'
    }))

    const response = await samlCallback(event)
    const { headers, statusCode } = response
    const { Location } = headers
    const cookies = headers['Set-Cookie']

    expect(statusCode).toBe(303)
    expect(Location).toBe('https://mmt.localtest.earthdata.nasa.gov/auth_callback?target=%2Fhome')
    expect(cookies).toEqual('data=eyJhdWlkIjoiY2dva2V5IiwiZW1haWwiOiJjaHJpc3RvcGhlci5kLmdva2V5QG5hc2EuZ292IiwibmFtZSI6ImNnb2tleSIsInRva2VuIjoiQUJDLTEifQ==; Path=/')
  })
})
